<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ChatApp</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }
    #chatContainer {
      height: 90vh;
      display: flex;
      flex-direction: column;
      background: #fff;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    #header {
      background: #4c6ef5;
      color: #fff;
      padding: 12px 20px;
      font-weight: 600;
      letter-spacing: 0.5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      background: #f1f3f5;
    }
    .msg {
      max-width: 70%;
      margin-bottom: 12px;
      padding: 10px 14px;
      border-radius: 16px;
      line-height: 1.4;
      word-wrap: break-word;
      position: relative;
      animation: fadeIn 0.2s ease-in;
    }
    .msg .meta {
      font-size: 0.8rem;
      opacity: 0.7;
      margin-top: 4px;
    }
    .msg.you {
      margin-left: auto;
      background: #4c6ef5;
      color: #fff;
      border-bottom-right-radius: 4px;
    }
    .msg.other {
      margin-right: auto;
      background: #fff;
      border: 1px solid #dee2e6;
      border-bottom-left-radius: 4px;
    }
    .system {
      text-align: center;
      font-size: 0.85rem;
      color: #868e96;
      margin: 8px 0;
    }
    #footer {
      display: flex;
      padding: 12px;
      background: #fff;
      border-top: 1px solid #dee2e6;
    }
    #messageInput {
      flex: 1;
      border-radius: 20px;
      border: 1px solid #ced4da;
      padding: 10px 14px;
      outline: none;
      transition: 0.2s;
    }
    #messageInput:focus {
      border-color: #4c6ef5;
      box-shadow: 0 0 0 3px rgba(76,110,245,0.2);
    }
    #sendBtn {
      border-radius: 50%;
      margin-left: 8px;
      width: 45px;
      height: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #typing {
      font-size: 0.8rem;
      margin-left: 14px;
      color: #495057;
    }
    @keyframes fadeIn {
      from {opacity: 0; transform: translateY(5px);}
      to {opacity: 1; transform: translateY(0);}
    }
  </style>
</head>
<body>
  <div class="container py-3">
    <div id="chatContainer">
      <!-- header -->
      <div id="header">
        <span>ðŸ’¬ ChatApp</span>
        <small id="typing"></small>
      </div>

      <!-- messages -->
      <div id="messages"></div>

      <!-- footer -->
      <div id="footer">
        <input id="messageInput" type="text" placeholder="Type a message..." autocomplete="off">
        <button id="sendBtn" class="btn btn-primary">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
            <path d="M15.854.146a.5.5 0 0 1 .11.54l-6 14a.5.5 0 0 1-.94-.04L7.07 9.36 1.354 6.854a.5.5 0 0 1 .04-.94l14-6a.5.5 0 0 1 .46.086z"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();
  let username = localStorage.getItem('chat-username') || prompt("Enter your name") || 'Guest';
  localStorage.setItem('chat-username', username);
  socket.emit('join', username);

  const messagesEl = document.getElementById('messages');
  const input = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const typingEl = document.getElementById('typing');

  function escapeHtml(s){
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  function appendSystem(text){
    const div = document.createElement('div');
    div.className = 'system';
    div.textContent = text;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function appendMessage(msg){
    const div = document.createElement('div');
    const self = (msg.user === username);
    div.className = `msg ${self ? 'you' : 'other'}`;
    const time = new Date(msg.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    div.innerHTML = `<div>${escapeHtml(msg.text)}</div>
                     <div class="meta">${escapeHtml(msg.user)} â€¢ ${time}</div>`;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  socket.on('chat-history', (msgs) => msgs.forEach(m => appendMessage(m)));
  socket.on('chat-message', (m) => appendMessage(m));
  socket.on('user-joined', (name) => appendSystem(`${name} joined the chat`));
  socket.on('user-left', (name) => appendSystem(`${name} left the chat`));

  let typingTimeout;
  input.addEventListener('input', () => {
    socket.emit('typing', true);
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(()=> socket.emit('typing', false), 800);
  });

  socket.on('typing', ({user, isTyping}) => {
    typingEl.textContent = isTyping ? `${user} is typing...` : '';
  });

  function sendMessage(){
    const text = input.value.trim();
    if(!text) return;
    socket.emit('chat-message', text);
    input.value = '';
    socket.emit('typing', false);
  }

  sendBtn.addEventListener('click', sendMessage);
  input.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });
</script>
</body>
                         </html>
